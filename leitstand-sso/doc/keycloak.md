# Leitstand Keycloak Integration

[Keycloak](https://www.keycloak.org) is an open source identity and access management system, that supports the OpenID authentication flow.

## Keycloak Setup

A Keycloak introduction goes beyond the scope of this document.
The following steps create a basic leitstand realm to test the Leitstand integration:

1. Create a _leistand_ realm in keycloak.
2. Select _Clients_  on the left menu and create a new client
	1. Use _leitstand_ as client ID
	2.Â Set _Access Type_ to _confidential_
	3. Proceed to the _Credentials_ tab and copy the generated client secret.
3. Select _Client Scopes_ on the left menu.
	1. Select the _roles_ scope.
	2. Proceed to the _Mappers_ tab.
	3. Select _realm roles_.
	4. Set _Token Claim Name_ to _roles_.
	5. Enable _Add to userinfo_.
4. Select _Users_ on the left menu. Click _Add user_ and follow the instructions to add a new user.
5. Select _Roles_ on the left menu. Click _Add role_ and follow the instructions to add a new role.
	1. Add a _leistand\_admin_ role.
	2. Proceed to the _User in Roles_ tab and assign the role to the previously generated user.
	3. Add a _leitstand\_operator_ role.
	4. Proceed to the _User in Roles_ tab and assign the role to the previously generated user.

Keycloak is now ready for being used by Leitstand.

## Leitstand Setup

Say Keycloak is available under `https://auth.leitstand.io` then the following settings are needed to connect Leistand with keycloak in `<LEITSTAND_ETC>/sso.properties`:

```Properties
# Login form to prompt the user for credentials
OIDC_AUTHORIZATION_ENDPOINT=https://auth.leitstand.io/auth/realms/leitstand/protocol/openid-connect/auth       
# Access token endpoint URL
OIDC_TOKEN_ENDPOINT=https://auth.leitstand.io/auth/realms/leitstand/protocol/openid-connect/token                    
# Userinfo endpoint to read the info of the authenticated user.
OIDC_USERINFO_ENDPOINT=https://auth.leitstand.io/auth/realms/leitstand/protocol/openid-connect/userinfo                 
# Timeouts for communication with keycloak.
OIDC_CONNECT_TIMEOUT=2000
OIDC_READ_TIMEOUT=10000                      
# Set client ID as specified in keycloak
OIDC_CLIENT_ID=leitstand
# Use the secret generated by keycload. 
# Optionally encrypt the secret with the Leitstand master secret.
OIDC_CLIENT_SECRET=14e8c466-3c12-4be1-840b-243cb0e2b980
# Read user roles from custom roles claim as specified in the realm setup.	               
OIDC_ROLES_CLAIM=roles
# Map leitstand-admin role to Administrator role.                       
OIDC_ROLE_leitstand-admin=Administrator
# Map leitstand-operator role to Operator role.
OIDC_ROLE_leitstand-operator=Operator
```

Note that _leitstand_ in each URI path segment matches the realm name, which was set to _leitstand_. 
The `OIDC_CLIENT_ID` and `OIDC_CLIENT_SECRET` values match the client ID and client secret specified in the realm.  
In addtion, the `OIDC_ROLES_CLAIM` is set to roles, which matches the roles claim name in the realm setup.

The location of `<LEITSTAND_ETC>` defaults to `/etc/leitstand` and can be modified by the `LEISTAND_ETC_ROOT` environment variable.
Alternatively all OIDC-properties can be specified as environment variables too.



