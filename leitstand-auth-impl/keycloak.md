# Leitstand Keycloak Integration

[Keycloak](https://www.keycloak.org) is an open source identity and access management system that supports the [OpenID Authentication Flow](https://openid.net/specs/openid-connect-basic-1_0.html#CodeFlow).

## Keycloak Setup

A Keycloak introduction goes beyond the scope of this document.
The following steps create a basic leitstand realm to test the Leitstand integration:

1. Create a _leistand_ realm in keycloak.
2. Select _Clients_  on the left menu and create a new client
	1. Use _leitstand_ as client ID
	2.Â Set _Access Type_ to _confidential_
	3. Proceed to the _Credentials_ tab and copy the generated client secret.
	4. Add the client secret to the Leitstand OIDC config.
3. Select _Roles_ on the left menu. Click _Add role_ and follow the instructions to add a new role.
	1. Add a _leistand-admin_ role.
	2. Proceed to the _User in Roles_ tab and assign the role to the previously generated user.
	3. Add a _leitstand-operator_ role.
	4. Proceed to the _User in Roles_ tab and assign the role to the previously generated user.
4. Select _Client Scopes_ on the left menu:
	1. Click the _Create_ button in the top-right corner to add a new scope.
	2. Enter _adm_ as scope name and click on the _Save_ button.
	3. Proceed to the _Scope_ tab.
	4. Select _leitstand-admin_ in available roles and click on the _Add selected_ button.
	5. Create the _ivt.read_ scope and assign it to the _leitstand-admin_ role.
	6. Create the _job.read_ scope and assign it to the _leitstand-admin_ role.	
	7. Create the _ivt_ scope and assign it to the _leitstand-operator_ role.
	8. Create the _job_ scope and assign it to the _leitstand-operator_ role.
5. Select _Clients_ on the left menu:
	1. Select _leitstand_ in the list of clients.
	2. Proceed to the _Client Scopes_ tab
	3. Select all created scopes in _Available Client Scopes_ and add them to _Assigned Default Client Scopes_.
6. Select _Users_ users on the left menu.
	1. Click on the _Add user_ button in the top-right corner.
	2. Provide a _Username_ and fill in the other form fields as needed.
	3. Click the _Save_ button.
	4. Select the _Credentials_ tab and set a (temporary) password.
	
A list of scopes is available per Leitstand module. 
Please feel free to define your own roles as needed.	
	
## Leitstand Setup

Say Keycloak is available under `https://auth.leitstand.io` then the following settings are needed to connect Leistand with keycloak in `<LEITSTAND_ETC>/sso.properties`:

```Properties
# Disvocer leitstand realm endpoints and keys from keyloak
OIDC_CONFIGURATION_ENDPOINT=https://auth.leitstand.io/auth/realms/leitstand/.well-known/openid-configuration 
# Timeouts for keycloak communication.
OIDC_CONNECT_TIMEOUT=2000
OIDC_READ_TIMEOUT=10000                      
# Set client ID as specified in keycloak
OIDC_CLIENT_ID=leitstand
# Use the secret generated by keycload. 
# Optionally encrypt the secret with the Leitstand master secret.
OIDC_CLIENT_SECRET=14e8c466-3c12-4be1-840b-243cb0e2b980
```

The location of `<LEITSTAND_ETC>` defaults to `/etc/leitstand` and can be modified by the `LEISTAND_ETC_ROOT` environment variable.
Alternatively all OIDC-properties can be specified as environment variables.



